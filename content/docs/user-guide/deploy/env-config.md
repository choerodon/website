+++
title = "环境配置"
description = ""
weight = 2
+++

# 环境配置

## 1. 概述

环境是Choerodon平台中部署资源的载体，即用户可以在环境中部署应用服务或其他资源。同时，Choerodon中的一个环境对应为k8s集群中的一个namespace。

环境配置模块包含了所有与环境相关的功能与设置，项目所有者可在此灵活地配置项目下所有的环境。

<blockquote class="note"> 
支持停用未连接状态的环境或不含资源的运行中状态的环境，但只能对停用或未连接状态的环境进行删除操作。
    </blockquote>

在环境配置页面，您可以通过左侧的树状导航来查看与管理环境分组和其中的环境。

此页面将会为您介绍如何创建和管理分组、环境，以及查看GitOps日志、管理部署配置、权限分配和资源安全设置。

### 前置条件

- 使用集群节点地址，用户名，密码连接到所要创建环境的集群机器上，确保集群内安装了helm。
- 创建环境前，请确保该项目中已存在可用的集群。在项目中创建集群的操作详见[集群管理](../cluster/cluster-manage)。

## 2. 管理环境分组

### 2.1 创建分组

方式一：当处于某一分组页面时，点击工具栏的`创建分组`，系统中会弹出创建环境分组的窗口，输入分组名称即可。

![image](/docs/user-guide/deploy/image/environment-01.png)

方式二：当处于某一环境页面时，点击![image](https://minio.choerodon.com.cn/knowledgebase-service/file_b53c0c1755864d7f9e3f7bb1f88b37fc_blob.png)标识，点击`创建分组`。

![image](/docs/user-guide/deploy/image/environment-02.png)

分组名称：限制为20个字符。

### 2.2 修改和删除分组

在树状导航处，选择想要进行操作的分组，点击名称后的![image](https://minio.choerodon.com.cn/knowledgebase-service/file_b53c0c1755864d7f9e3f7bb1f88b37fc_blob.png)标识，即可进行修改和删除操作。

![image](/docs/user-guide/deploy/image/environment-03.png)

## 3. 创建和管理环境

### 3.1 创建环境

1. 点击工具栏`创建环境`，系统会滑出创建环境页。

2. 输入或选择相关信息，包括集群、环境编码、环境名称、环境描述；若项目所有者需要为该环境分配特定的操作人员，需要进入对应环境的详情，点击`权限管理`按钮即可。

    - 选择集群：此处只能选择已对该项目授权的集群进行连接；连接后，环境的状态由所连的集群决定，若集群是运行中，则该环境也是运行中的状态，集群未连接，则环境也是未连接；若想激活环境，只有先将集群激活。
    - 环境编码：k8s集群中namespace的名称，限制60个字符。
        <blockquote class="note"> 
        只能由小写字母、数字、”-“组成，且以小写字母开头，不能以”-“结尾
        </blockquote>
    - 环境名称：平台环境的显示名称。现在为10个字符。
    - 环境描述：环境的描述，限制为60字符。
    - 环境分组：环境的分组，只能从已创建的分组中进行选择，从而将此环境放入该分组中。
        <blockquote class="note"> 
        根据用途配置不同的环境，常见的有开发环境，集成测试环境，用户访问测试环境及正式环境。同时，可以为这些环境分别配置特定的操作人员，配置后，只有被勾选的成员才能在对应的环境下进行部署相关的操作。新环境默认新增在环境流水线的最后一个节点。
        </blockquote>

3. 填写完成后，点击创建，回到环境管理界面；若所连接的集群状态为运行中，则该环境的状态为运行中，如果对应集群未连接，那么该环境也是未连接。若想激活环境，只有先将集群激活。

### 3.2 修改、停用和删除环境  

各状态的环境对应的可执行操作如下表：

环境状态|可执行操作
----|----
运行中（且环境中无资源）|修改、停用
运行中（环境中存在实例、网络域名等资源）|修改  
未连接|修改、删除  
停用|启用、删除


在树状导航处，选择想要进行操作的环境，点击名称后的![image](https://minio.choerodon.com.cn/knowledgebase-service/file_b53c0c1755864d7f9e3f7bb1f88b37fc_blob.png)标识，即可进行修改、停用和删除操作。

![image](/docs/user-guide/deploy/image/environment-04.png)

## 4. 查看GitOps日志

因为目前的部署方式为[GitOps](http://choerodon.io/zh/blog/gitops/) 操作，日志页面用于展示目前代码的提交同步情况，同时列举出操作同步过程中产生的错误信息。

点击某个环境，可以直接查看GitOps日志，包含提交同步情况和错误日志两部分内容。

![image](/docs/user-guide/deploy/image/environment-05.png)

- 由于目前的部署方式为 [GitOps](http://choerodon.io/zh/blog/gitops/)操作，因此在过程中可以对一些不当的操作进行错误的追踪。而产生报错日志显示在日志页签下。
- 提交同步情况：由于 GitOps 对部署信息进行异步处理，提交同步情况可以查看当前对部署信息的解析进度。点击提交的 commit SHA 可以查看对应的 GitOps 代码仓库。
- 错误日志：显示解析过程中产生的错误信息以及错误的文件源，点击文件可以跳转查看产生错误的文件。
- 若是在解析或执行过程中出现错误，此时在提交同步情况中，三个过程下面的 commit SHA会出现不一致的情况，同时错误日志中显示具体错误信息。而在实例状态总览左侧也会显示目前正在“同步中”，只有解决了当前的错误，才能进行接下来的操作。
- 重试：当阶段一（配置库）与阶段二（已解析）的commit SHA不一致时，可点击阶段一与阶段二之间的重试按钮→ 重试按钮 来重试GitOps。

## 5. 部署配置

部署配置用于管理部署应用时需要用到的配置信息（包括流水线中的自动部署任务）。创建成功后的部署配置将能在部署应用的过程中进行选择与使用。

先选中某个环境，进入该环境的详情页面，点击 `部署配置`页签，进入部署配置的详情页。

### 5.1 创建部署配置

1. 点击工具栏 `创建部署配置`，右侧会弹出创建部署配置的页面；

    ![image](/docs/user-guide/deploy/image/environment-06.png)

2. 填写部署配置名称，此处名称在项目下唯一；
3. 填写描述，用于描述此部署配置的用途；
4. 选择应用服务；
5. 修改配置信息，选择应用与环境之后会出现一个默认的配置信息，可以在此对其进行修改。

### 5.2 查看部署配置

点击`部署配置`，进入至部署配置主界面。通过列表，可以查看到部署配置的名称、描述、对应的服务与对应的环境，以及创建者和更新时间。

![image](/docs/user-guide/deploy/image/environment-07.png)

### 5.3 编辑部署配置

在列表中，点击对应部署配置的名称后，会弹出部署配置的修改界面，支持修改部署配置中的名称、描述以及对应的配置信息。

<blockquote class="note">
修改了部署配置中的配置信息后，流水线中已选择该部署配置的部署任务在之后的自动部署时，会直接使用最新的部署配置。
创建成功后的部署配置不支持修改其中的应用服务与环境。
</blockquote>

### 5.4 删除部署配置

点击名称后的![image](https://minio.choerodon.com.cn/knowledgebase-service/file_b53c0c1755864d7f9e3f7bb1f88b37fc_blob.png)标识，可以删除对应的部署配置。

<blockquote class="note">
仅能删除没有关联流水线部署任务以及没有关联实例的部署配置。 
</blockquote>

## 6. 权限分配

###  6.1 查看权限分配详情

1. 在树结构中点击某个环境的名称，点击`权限分配`页签进入权限分配详情页。
2. 查看已被分配环境权限的项目人员的用户名、登录名以及项目角色，并且可通过过滤表快速搜索目标人员。  

![image](/docs/user-guide/deploy/image/environment-08.png)

* 用户名：团队成员的名称；
* 登录名：团队成员的系统登录名称；
* 项目角色：团队成员的项目角色，有项目成员和项目所有者两种；
* 添加时间：添加角色权限的时间；

### 6.2 权限管理

在此页面点击顶部的 `权限管理`进入权限管理的操作界面，便可为该环境配置特定的操作人员。

![image](/docs/user-guide/deploy/image/environment-09.png)

1. 设置该环境的操作人员
    * 项目下所有成员：即该项目下所有项目成员都能在此环境中部署应用服务和资源；
    * 项目下特定成员：选择为`项目下特定成员`后，您需要在下方添加成员来分配权限，只有被分配权限的项目成员才能在此环境中部署应用服务和资源；
2. 点击`保存`，回到权限分配的详情页面，页面中显示出刚配置的权限人员，即权限分配成功。

<blockquote class="note">
项目所有者默认拥有项目下所有环境的权限，且不能被删除。
</blockquote>

### 6.3 删除权限

在`权限分配`页签下的列表中，选中某个已被分配权限的项目成员，点击删除按钮，即可删除该成员在此应用服务中的开发权限。

<blockquote class="note">
只有在权限管理页面中将权限分配给`项目下特定成员`时，才能在列表中删除某个成员的权限；若将权限分配给项目下所有成员，则不能在列表中删除任何成员的权限。
</blockquote>

权限配置成功后，有权限的项目成员便可在该环境中进行应用部署、实例管理、网络管理、域名管理以及证书管理的操作。



## 8. 阅读更多

- [应用部署](../app-deploy)
- [集群](../cluster)
